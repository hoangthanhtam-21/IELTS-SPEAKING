<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Practice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }
        /* Waveform Animation */
        .bar { width: 4px; height: 16px; background: #6366f1; border-radius: 2px; transition: height 0.1s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700 flex items-center gap-2">
                    <i data-lucide="award" class="w-8 h-8"></i>
                    IELTS Speaking AI
                </h1>
                <p class="text-slate-500">Full Question Bank & 4-Criteria Assessment</p>
            </div>
            <button onclick="generateExam()" class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg active:scale-95">
                <i data-lucide="play" class="w-5 h-5"></i>
                Start Full Mock Test
            </button>
        </header>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="bg-white rounded-3xl p-12 text-center shadow-sm border border-slate-100">
            <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-500">
                <i data-lucide="mic-2" class="w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Ready for your simulation?</h2>
            <p class="text-slate-500 mb-8 max-w-md mx-auto">Hệ thống sẽ dẫn dắt bạn qua 3 phần thi. Kết quả sẽ được chấm điểm chi tiết dựa trên tiêu chuẩn IELTS quốc tế.</p>
        </div>

        <!-- Exam UI -->
        <div id="exam-container" class="hidden space-y-6">
            <!-- Loading/Grading Overlay -->
            <div id="grading-overlay" class="hidden flex flex-col items-center justify-center p-12 bg-white/90 backdrop-blur rounded-3xl border-2 border-indigo-200 animate-fade-in z-50">
                <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                <h3 class="text-xl font-bold text-slate-800" id="grading-status-text">AI is analyzing...</h3>
                <p class="text-slate-500 text-sm mt-2" id="grading-subtext">Vui lòng chờ trong giây lát để hệ thống chấm điểm Part vừa hoàn thành.</p>
            </div>

            <!-- Part Score Screen (Intermediate) -->
            <section id="part-result-area" class="hidden bg-white rounded-3xl p-8 shadow-sm border border-indigo-100 animate-fade-in">
                <div class="text-center mb-6">
                    <div class="bg-indigo-600 text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <span id="part-score-val" class="text-3xl font-black">0.0</span>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800">Kết quả Part <span id="part-num-val">1</span></h3>
                </div>
                
                <!-- Detailed Criteria for Part -->
                <div id="part-detailed-scores" class="grid sm:grid-cols-2 gap-4 mb-6">
                    <!-- Criteria cards will be injected here -->
                </div>

                <div class="bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Lời khuyên của giám khảo cho Part này:</h4>
                    <p id="part-feedback-brief" class="text-slate-600 text-sm italic leading-relaxed"></p>
                </div>

                <div class="text-center">
                    <button onclick="nextStep()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-3 rounded-xl font-bold shadow-md transition-all">
                        Tiếp tục <i data-lucide="arrow-right" class="w-5 h-5 inline-block ml-1"></i>
                    </button>
                </div>
            </section>

            <!-- Examiner Box -->
            <section id="main-test-area" class="bg-white rounded-3xl p-8 shadow-sm border border-indigo-100 relative overflow-hidden">
                <div class="relative z-10 flex flex-col items-center text-center">
                    <div id="part-indicator" class="mb-2 px-4 py-1 bg-indigo-100 text-indigo-700 text-xs font-bold rounded-full uppercase tracking-widest">Part 1</div>
                    <div id="narrator-text" class="text-slate-500 italic mb-4">The examiner is preparing...</div>
                    
                    <div id="question-display" class="text-2xl md:text-3xl font-bold text-slate-800 mb-8 min-h-[120px] flex items-center justify-center animate-fade-in text-center px-4">
                        Question will appear here
                    </div>

                    <!-- Part 2 Countdown -->
                    <div id="p2-timer-container" class="hidden mb-8 p-4 bg-amber-50 rounded-2xl border border-amber-100 w-full max-w-xs">
                        <div id="p2-timer-label" class="text-xs font-bold text-amber-700 uppercase mb-1">Preparation Time</div>
                        <div id="p2-timer-countdown" class="text-4xl font-mono font-black text-amber-600">01:00</div>
                    </div>

                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="speak-btn" onclick="repeatQuestion()" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg transition-colors">
                            <i data-lucide="volume-2" class="w-5 h-5"></i> Repeat
                        </button>
                        <button id="p2-prep-btn" onclick="startP2Prep()" class="hidden flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-8 py-3 rounded-xl font-bold shadow-md transition-all">
                            Start Prep <i data-lucide="timer" class="w-5 h-5"></i>
                        </button>
                        <button id="next-btn" onclick="nextStep()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-md transition-all">
                            Next <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Rec Area -->
            <section id="recording-section" class="bg-slate-900 rounded-3xl p-6 text-white shadow-xl flex items-center justify-between hidden">
                <div class="flex items-center gap-6">
                    <div id="rec-dot" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                    <div class="flex flex-col">
                        <div class="text-xs uppercase font-bold text-slate-400 tracking-tighter">Recording Part <span id="rec-part-num">1</span></div>
                        <div id="timer-display" class="text-2xl font-mono font-bold">0:00</div>
                    </div>
                </div>
                <!-- Visual Feedback for Mic -->
                <div class="flex items-center gap-1 h-8" id="visualizer-bars">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">Auto-capturing Audio</p>
                    <p class="text-xs italic text-indigo-300">Speaking now...</p>
                </div>
            </section>

            <!-- Audio Review -->
            <section id="final-audio-preview" class="hidden bg-slate-100 p-6 rounded-3xl border border-slate-200 flex flex-col items-center gap-4 animate-fade-in">
                <h4 class="font-bold text-slate-700">Review Last Recording</h4>
                <audio id="audio-playback" controls class="w-full"></audio>
                <button onclick="downloadRecording()" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Download recording
                </button>
            </section>

            <!-- Final Report Area -->
            <section id="feedback-area" class="hidden bg-white rounded-3xl p-8 shadow-2xl border-2 border-indigo-100 animate-fade-in">
                <div class="text-center mb-8 border-b pb-6">
                    <h2 class="text-3xl font-black text-slate-800 mb-2 uppercase">IELTS Speaking Full Report</h2>
                    <p class="text-slate-500">Based on Official Band Descriptors</p>
                </div>

                <!-- Scores Header -->
                <div class="grid md:grid-cols-4 gap-6 mb-10">
                    <div class="bg-indigo-600 text-white p-8 rounded-3xl flex flex-col items-center justify-center shadow-xl">
                        <span class="text-xs uppercase font-bold opacity-80 mb-1">Overall Band</span>
                        <span id="final-score" class="text-7xl font-black">0.0</span>
                    </div>
                    <div class="md:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-4" id="criteria-scores-summary">
                        <!-- Score criteria summarized -->
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="space-y-6" id="detailed-feedback-list"></div>

                <div class="mt-10 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-slate-800 mb-2">Examiner's Final Advice:</h4>
                    <p id="final-advice" class="text-slate-600 text-sm leading-relaxed italic"></p>
                </div>

                <button onclick="location.reload()" class="mt-8 w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                    Restart Practice
                </button>
            </section>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        const QUESTION_BANK = {
            part1: [
                { text: "Do you like shopping?" }, { text: "Do you compare prices when you shop? Why?" },
                { text: "Is it difficult for you to make choices when you shop?" }, { text: "Do you think expensive products are always better than cheaper ones?" },
                { text: "Do you think hobbies are important?" }, { text: "Which hobby do you like to try in the future?" },
                { text: "What do you like to do on the weekends?" }, { text: "Do you like to spend your free time with families or friends?" },
                { text: "What will you do if you go out?" }, { text: "What kind of TV programs do you like?" },
                { text: "Do you prefer to read local news or international news?" }, { text: "Who is your favorite celebrity in your country?" },
                { text: "What types of people become famous in your country?" }, { text: "Would you like to be a famous person?" },
                { text: "Do you like any foreign celebrities?" }, { text: "How do celebrities influence their fans in your country?" },
                { text: "Is there much pollution where you live?" }, { text: "Are residents in your town good at recycling waste?" },
                { text: "Do you take an interest in nature?" }, { text: "Have you ever participated in any environmental events?" },
                { text: "What kinds of animals are popular pets in your country? Why?" }, { text: "Do you think pollution is a big problem nowadays?" }
            ],
            topicSets: [
                {
                    topic: "Possessions & Shopping",
                    part2: "Describe something you own that you want to replace\nYou should say:\n• What it is\n• Where it is\n• How you got it\n• And explain why you want to replace it",
                    part3: [
                        "What risks would you take when shopping online? Why?",
                        "Will large shopping malls continue to be popular, despite the growth of internet shopping?",
                        "What are the disadvantages of shopping in a street market?",
                        "Why do you think some people replace things more often than others?",
                        "Does consumption have any impact on the environment?",
                        "Is advertising important?"
                    ]
                },
                {
                    topic: "Shopping Centers",
                    part2: "Describe a shopping center you often go to.\nYou should say:\n• Where is it?\n• How often do you go there?\n• How is its appearance?\n• Why do you often go there?",
                    part3: [
                        "What risks would you take when shopping online? Why?",
                        "Will large shopping malls continue to be popular, despite the growth of internet shopping?",
                        "What are the disadvantages of shopping in a street market?",
                        "Why do you think some people replace things more often than others?",
                        "Does consumption have any impact on the environment?",
                        "Is advertising important?"
                    ]
                },
                {
                    topic: "Leisure Time",
                    part2: "Describe your leisure time. You should say:\n• How you usually spend your leisure time\n• Who you prefer to spend your leisure time with\n• What leisure activities are popular in your country\n• And explain why leisure time is important to you",
                    part3: [
                        "How has the way we spend free time changed over the years?",
                        "Do you think only old people have time for leisure?",
                        "Do women have more leisure time than men?",
                        "Some people believe that traditional leisure activities are losing popularity. Why do you think this is happening?",
                        "Do you think it’s important for people to try new leisure activities? Why?"
                    ]
                },
                {
                    topic: "Famous People & News",
                    part2: "Describe a famous person who is not from your country you would like to meet.\nYou should say:\n• Who that person is\n• Why you admire him/her\n• What would you say if you met him/her",
                    part3: [
                        "Do you think the internet influences the types of news stories people hear about?",
                        "Why do you think the internet is becoming a more popular source of news?",
                        "What are some of the disadvantages of being a celebrity?",
                        "What are some of the advantages of being a celebrity?",
                        "Do you think the media is putting too much attention on famous people?",
                        "How do most people find out about the news in your country?"
                    ]
                },
                {
                    topic: "Environmental Problems",
                    part2: "Describe an environmental problem in your hometown.\nYou should say:\n• what problem is it?\n• what causes the problem?\n• what can be done to address the problem?",
                    part3: [
                        "What do you think is the main danger the world faces in terms of the environment?",
                        "In which way do people damage our planet?"
                    ]
                }
            ]
        };

        let state = {
            activeExam: null, currentPart: 1, p1Index: -1, p3Index: -1, p2Phase: 'intro',
            mediaRecorder: null, audioChunks: [], isRecording: false, timer: 0, timerId: null,
            partResults: { 1: null, 2: null, 3: null }, lastBlob: null, p2SpeakingInterval: null,
            audioContext: null, analyser: null, visualizerId: null, showingIntermediateResult: false
        };

        function ieltsRounding(score) {
            const fraction = score % 1;
            if (fraction < 0.25) return Math.floor(score);
            if (fraction >= 0.25 && fraction < 0.75) return Math.floor(score) + 0.5;
            return Math.ceil(score);
        }

        function generateExam() {
            speak(""); 
            const shuffledP1 = [...QUESTION_BANK.part1].sort(() => 0.5 - Math.random()).slice(0, 5);
            const randomSet = QUESTION_BANK.topicSets[Math.floor(Math.random() * QUESTION_BANK.topicSets.length)];
            const shuffledP3 = [...randomSet.part3].sort(() => 0.5 - Math.random()).slice(0, 3);
            
            state = {
                ...state,
                activeExam: { p1: shuffledP1, p2: randomSet.part2, p3: shuffledP3, topic: randomSet.topic },
                currentPart: 1, p1Index: -1, p3Index: -1, p2Phase: 'intro', audioChunks: [],
                partResults: { 1: null, 2: null, 3: null }, isRecording: false, showingIntermediateResult: false
            };
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('final-audio-preview').classList.add('hidden');
            document.getElementById('part-result-area').classList.add('hidden');
            document.getElementById('main-test-area').classList.remove('hidden');
            updateFlow();
        }

        async function startPartRecording() {
            if (state.isRecording) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioContext.createAnalyser();
                const source = state.audioContext.createMediaStreamSource(stream);
                source.connect(state.analyser);
                state.analyser.fftSize = 64;
                const bufferLength = state.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const bars = document.querySelectorAll('.bar');
                function draw() {
                    if (!state.isRecording) return;
                    state.visualizerId = requestAnimationFrame(draw);
                    state.analyser.getByteFrequencyData(dataArray);
                    bars.forEach((bar, i) => {
                        const val = dataArray[i] || 0;
                        const height = Math.max(4, val / 4);
                        bar.style.height = `${height}px`;
                    });
                }
                draw();
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                state.mediaRecorder = new MediaRecorder(stream, { mimeType });
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.audioChunks.push(e.data); };
                state.mediaRecorder.start();
                state.isRecording = true; state.timer = 0;
                document.getElementById('recording-section').classList.remove('hidden');
                document.getElementById('rec-part-num').innerText = state.currentPart;
                state.timerId = setInterval(() => {
                    state.timer++;
                    const m = Math.floor(state.timer / 60); const s = state.timer % 60;
                    document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                }, 1000);
            } catch (err) { alert("Microphone access denied."); }
        }

        function stopPartRecording() {
            return new Promise((resolve) => {
                if (!state.mediaRecorder || state.mediaRecorder.state === "inactive") {
                    state.isRecording = false; clearInterval(state.timerId);
                    cancelAnimationFrame(state.visualizerId); return resolve(null);
                }
                state.mediaRecorder.onstop = () => {
                    const blob = new Blob(state.audioChunks, { type: state.mediaRecorder.mimeType });
                    state.lastBlob = blob; state.isRecording = false;
                    clearInterval(state.timerId); cancelAnimationFrame(state.visualizerId);
                    document.getElementById('recording-section').classList.add('hidden');
                    document.getElementById('audio-playback').src = URL.createObjectURL(blob);
                    document.getElementById('final-audio-preview').classList.remove('hidden');
                    if (state.audioContext) state.audioContext.close();
                    resolve(blob);
                };
                state.mediaRecorder.stop();
            });
        }

        function updateFlow() {
            const display = document.getElementById('question-display');
            const indicator = document.getElementById('part-indicator');
            const nextBtn = document.getElementById('next-btn');
            const p2PrepBtn = document.getElementById('p2-prep-btn');
            const p2Timer = document.getElementById('p2-timer-container');
            const narrator = document.getElementById('narrator-text');

            p2PrepBtn.classList.add('hidden'); p2Timer.classList.add('hidden'); nextBtn.classList.remove('hidden');

            if (state.currentPart === 1) {
                indicator.innerText = "Part 1";
                if (state.p1Index === -1) {
                    narrator.innerText = "Introduction";
                    display.innerText = "Now, in this first part, I'd like to ask you some personal questions. Are you ready?";
                    nextBtn.innerText = "Start Recording Part 1";
                } else {
                    narrator.innerText = `Question ${state.p1Index + 1} of 5`;
                    display.innerText = state.activeExam.p1[state.p1Index].text;
                    nextBtn.innerText = (state.p1Index === state.activeExam.p1.length - 1) ? "Finish Part 1" : "Next Question";
                    startPartRecording();
                }
            } else if (state.currentPart === 2) {
                indicator.innerText = "Part 2";
                if (state.p2Phase === 'intro') {
                    narrator.innerText = "Instruction";
                    display.innerText = "I'm going to give you a topic. You will have 1 minute to prepare.";
                    nextBtn.classList.add('hidden'); p2PrepBtn.classList.remove('hidden');
                } else if (state.p2Phase === 'prep') {
                    narrator.innerText = "Preparation (1 minute)";
                    display.innerHTML = `<div class="text-left bg-indigo-50 p-6 rounded-xl text-lg italic border border-indigo-100 shadow-inner">${state.activeExam.p2.replace(/\n/g, '<br>')}</div>`;
                    nextBtn.classList.add('hidden'); p2Timer.classList.remove('hidden');
                } else if (state.p2Phase === 'speak') {
                    narrator.innerText = "Speaking (2 minutes)";
                    display.innerHTML = `<div class="text-left bg-indigo-50 p-6 rounded-xl text-lg italic border border-indigo-100 shadow-inner">${state.activeExam.p2.replace(/\n/g, '<br>')}</div>`;
                    nextBtn.innerText = "Finish Part 2"; p2Timer.classList.remove('hidden');
                    document.getElementById('p2-timer-label').innerText = "Speaking Time";
                    startPartRecording();
                }
            } else if (state.currentPart === 3) {
                indicator.innerText = "Part 3";
                if (state.p3Index === -1) {
                    narrator.innerText = "Discussion";
                    display.innerText = "Let's discuss more general questions about " + state.activeExam.topic;
                    nextBtn.innerText = "Start Recording Part 3";
                } else {
                    narrator.innerText = `Question ${state.p3Index + 1} of ${state.activeExam.p3.length}`;
                    display.innerText = state.activeExam.p3[state.p3Index];
                    nextBtn.innerText = (state.p3Index === state.activeExam.p3.length - 1) ? "Finish Full Test" : "Next Question";
                    startPartRecording();
                }
            }
            if (!(state.currentPart === 2 && state.p2Phase === 'speak')) speak(display.innerText);
            try { lucide.createIcons(); } catch(e) {}
        }

        async function nextStep() {
            if (state.p2SpeakingInterval) { clearInterval(state.p2SpeakingInterval); state.p2SpeakingInterval = null; }
            
            if (state.showingIntermediateResult) {
                state.showingIntermediateResult = false;
                document.getElementById('part-result-area').classList.add('hidden');
                document.getElementById('main-test-area').classList.remove('hidden');
                
                if (state.currentPart === 1) {
                    state.currentPart = 2; updateFlow();
                } else if (state.currentPart === 2) {
                    state.currentPart = 3; updateFlow();
                } else if (state.currentPart === 3) {
                    showFinalReport();
                }
                return;
            }

            if (state.currentPart === 1) {
                if (state.p1Index === -1) state.p1Index = 0;
                else if (state.p1Index === state.activeExam.p1.length - 1) {
                    const blob = await stopPartRecording(); await gradePart(1, blob);
                    displayIntermediateScore(1); return;
                } else state.p1Index++;
            } else if (state.currentPart === 2) {
                const blob = await stopPartRecording(); await gradePart(2, blob);
                displayIntermediateScore(2); return;
            } else if (state.currentPart === 3) {
                if (state.p3Index === -1) state.p3Index = 0;
                else if (state.p3Index === state.activeExam.p3.length - 1) {
                    const blob = await stopPartRecording(); await gradePart(3, blob);
                    displayIntermediateScore(3); return;
                } else state.p3Index++;
            }
            updateFlow();
        }

        function displayIntermediateScore(num) {
            state.showingIntermediateResult = true;
            document.getElementById('main-test-area').classList.add('hidden');
            document.getElementById('final-audio-preview').classList.add('hidden');
            const resArea = document.getElementById('part-result-area');
            resArea.classList.remove('hidden');
            
            const partData = state.partResults[num];
            document.getElementById('part-num-val').innerText = num;
            document.getElementById('part-score-val').innerText = partData.overall.toFixed(1);
            document.getElementById('part-feedback-brief').innerText = partData.advice;

            // Display detailed criteria
            const criteriaContainer = document.getElementById('part-detailed-scores');
            const criteria = [
                { name: "Fluency & Coherence", data: partData.fc },
                { name: "Lexical Resource", data: partData.lr },
                { name: "Grammar Accuracy", data: partData.gra },
                { name: "Pronunciation", data: partData.p }
            ];

            criteriaContainer.innerHTML = criteria.map(c => `
                <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 flex flex-col gap-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-indigo-700 uppercase">${c.name}</span>
                        <span class="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">Band ${c.data.score.toFixed(1)}</span>
                    </div>
                    <p class="text-[11px] text-slate-600 leading-tight line-clamp-3">${c.data.feedback}</p>
                </div>
            `).join('');
            
            const btn = resArea.querySelector('button');
            if (num === 3) {
                btn.innerHTML = `Xem báo cáo tổng hợp <i data-lucide="award" class="w-5 h-5 inline-block ml-1"></i>`;
            } else {
                btn.innerHTML = `Tiếp tục sang Part ${num + 1} <i data-lucide="arrow-right" class="w-5 h-5 inline-block ml-1"></i>`;
            }
            try { lucide.createIcons(); } catch(e) {}
        }

        function startP2Prep() {
            state.p2Phase = 'prep'; updateFlow();
            document.getElementById('p2-timer-container').classList.remove('hidden');
            document.getElementById('p2-prep-btn').classList.add('hidden');
            let time = 60;
            const interval = setInterval(() => {
                time--; document.getElementById('p2-timer-countdown').innerText = `00:${time.toString().padStart(2, '0')}`;
                if (time <= 0) {
                    clearInterval(interval);
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
                    window.speechSynthesis.cancel();
                    const promptMsg = new SpeechSynthesisUtterance("Time is up. Please start speaking now.");
                    promptMsg.lang = 'en-GB';
                    const triggerP2Speaking = () => {
                        if (state.p2Phase === 'speak') return;
                        state.p2Phase = 'speak'; updateFlow();
                        let speakTime = 120; document.getElementById('p2-timer-countdown').innerText = "02:00";
                        state.p2SpeakingInterval = setInterval(() => {
                            speakTime--;
                            const m = Math.floor(speakTime / 60); const s = speakTime % 60;
                            document.getElementById('p2-timer-countdown').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                            if (speakTime <= 0) { clearInterval(state.p2SpeakingInterval); state.p2SpeakingInterval = null; speak("Thank you. Time is up."); }
                        }, 1000);
                    };
                    const safetyTimeout = setTimeout(triggerP2Speaking, 3500);
                    promptMsg.onend = () => { clearTimeout(safetyTimeout); triggerP2Speaking(); };
                    window.speechSynthesis.speak(promptMsg);
                }
            }, 1000);
        }

        async function gradePart(num, blob) {
            const overlay = document.getElementById('grading-overlay'); overlay.classList.remove('hidden');
            if (!blob || blob.size < 1000) { 
                state.partResults[num] = { overall: 0, fc: {score:0, feedback:"Không phát hiện lời nói."}, lr: {score:0, feedback:""}, gra: {score:0, feedback:""}, p: {score:0, feedback:""}, advice: "Không ghi nhận được âm thanh. Band điểm 0." };
                overlay.classList.add('hidden'); return;
            }
            const base64 = await new Promise(r => {
                const reader = new FileReader(); reader.onloadend = () => r(reader.result.split(',')[1]); reader.readAsDataURL(blob);
            });
            const prompt = `Act as an expert IELTS Speaking Examiner. Evaluate the user's speech in Part ${num}. Provide scores for 4 criteria and a final advice in Vietnamese. Return JSON only: { "overall": number, "fc": {"score": number, "feedback": "chi tiết"}, "lr": {"score": number, "feedback": "chi tiết"}, "gra": {"score": number, "feedback": "chi tiết"}, "p": {"score": number, "feedback": "chi tiết"}, "advice": "lời khuyên" }`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            let success = false;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Evaluate Part " + num }, { inlineData: { mimeType: blob.type, data: base64 } }] }], systemInstruction: { parts: [{ text: prompt }] }, generationConfig: { responseMimeType: "application/json" } }) });
                    if (response.ok) {
                        const data = await response.json();
                        state.partResults[num] = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
                        success = true; break;
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
            }
            if (!success) {
                state.partResults[num] = { overall: 0, fc: {score:0, feedback:""}, lr: {score:0, feedback:""}, gra: {score:0, feedback:""}, p: {score:0, feedback:""}, advice: "Lỗi kết nối." };
            }
            overlay.classList.add('hidden');
        }

        function showFinalReport() {
            document.getElementById('main-test-area').classList.add('hidden');
            document.getElementById('part-result-area').classList.add('hidden');
            document.getElementById('final-audio-preview').classList.add('hidden');
            document.getElementById('feedback-area').classList.remove('hidden');
            const getAvg = (key) => {
                const scores = [state.partResults[1]?.[key]?.score || 0, state.partResults[2]?.[key]?.score || 0, state.partResults[3]?.[key]?.score || 0];
                return scores.reduce((a, b) => a + b, 0) / 3;
            };
            const avgFC = getAvg('fc'), avgLR = getAvg('lr'), avgGRA = getAvg('gra'), avgP = getAvg('p');
            const roundedOverall = ieltsRounding((avgFC + avgLR + avgGRA + avgP) / 4);
            document.getElementById('final-score').innerText = roundedOverall.toFixed(1);
            document.getElementById('criteria-scores-summary').innerHTML = [
                { l: "Fluency", v: avgFC }, { l: "Lexical", v: avgLR }, { l: "Grammar", v: avgGRA }, { l: "Pronun", v: avgP }
            ].map(c => `<div class="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl text-center"><div class="text-[10px] uppercase font-bold text-indigo-400 mb-1">${c.l}</div><div class="text-2xl font-black text-indigo-700">${c.v.toFixed(1)}</div></div>`).join('');
            const details = [
                { name: "Fluency & Coherence", score: avgFC, data: state.partResults[3]?.fc || state.partResults[2]?.fc || state.partResults[1]?.fc },
                { name: "Lexical Resource", score: avgLR, data: state.partResults[3]?.lr || state.partResults[2]?.lr || state.partResults[1]?.lr },
                { name: "Grammar Accuracy", score: avgGRA, data: state.partResults[3]?.gra || state.partResults[2]?.gra || state.partResults[1]?.gra },
                { name: "Pronunciation", score: avgP, data: state.partResults[3]?.p || state.partResults[2]?.p || state.partResults[1]?.p }
            ];
            document.getElementById('detailed-feedback-list').innerHTML = details.map(d => `
                <div class="bg-white border border-slate-100 p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-bold text-slate-800">${d.name}</h5>
                        <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">Band ${d.score.toFixed(1)}</span>
                    </div>
                    <p class="text-slate-600 text-sm leading-relaxed">${d.data?.feedback || "N/A"}</p>
                </div>
            `).join('');
            document.getElementById('final-advice').innerText = state.partResults[3]?.advice || "Hoàn thành bài luyện tập.";
            try { lucide.createIcons(); } catch(e) {}
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function speak(text) {
            window.speechSynthesis.cancel(); if (!text) return;
            const msg = new SpeechSynthesisUtterance(text); msg.lang = 'en-GB'; window.speechSynthesis.speak(msg);
        }

        function repeatQuestion() { speak(document.getElementById('question-display').innerText); }
    </script>
</body>
</html>
